{% extends "base_database.html" %}
{% from 'includes/navbars.html' import orgbar, ccassholdbar %}

{% block title %}Holdings of unnamed Investor Participants in a stock{% endblock %}

{% block extra_head %}
<script type="text/javascript" src="/static/js/highstock.js"></script>
<script type="text/javascript" src="/static/js/exporting.js"></script>
{% endblock %}

{% block content %}
{% if issue_id == 0 %}
	<h2>Holdings of unnamed Investor Participants</h2>
	<p><b>{{ stock_name }}</b></p>
{% else %}
	{{ orgbar(stock_name, person_id, 0, 0) }}
	{{ ccassholdbar(issue_id, at_date, 4, current_stock_code, hk_listings) }}
{% endif %}

<form method="get" action="nciphist.asp">
	<input type="hidden" name="i" value="{{ issue_id }}">
	<div class="inputs">
		Stock code: <input type="text" name="sc" id="stockCode" size="5" value="">
	</div>
	<div class="clear"></div>
	<div class="inputs">
		<p>Adjust for splits and bonus issues:
			<input type="radio" name="a" value="1" {{ 'checked' if a else '' }} onchange="this.form.submit()">Yes
			<input type="radio" name="a" value="0" {{ 'checked' if not a else '' }} onchange="this.form.submit()">No
		</p>
		<p>Use price on:
			<input type="radio" name="p" value="0" {{ 'checked' if not p else '' }} onchange="this.form.submit()">trading date
			<input type="radio" name="p" value="1" {{ 'checked' if p else '' }} onchange="this.form.submit()">holding/settlement date
		</p>
		<p>Show:
		<input type="radio" name="s" value="0" {{ 'checked' if s == 0 else '' }} onchange="this.form.submit()">chart &amp; table
		<input type="radio" name="s" value="1" {{ 'checked' if s == 1 else '' }} onchange="this.form.submit()">chart only
		<input type="radio" name="s" value="2" {{ 'checked' if s == 2 else '' }} onchange="this.form.submit()">table only
		</p>
		<p>Table rows with no holding change:
			<input type="radio" name="o" value="1" {{ 'checked' if o else '' }} onchange="this.form.submit()">include
			<input type="radio" name="o" value="0" {{ 'checked' if not o else '' }} onchange="this.form.submit()">exclude
		</p>
		<input type="submit" value="Go">
	</div>
	<div class="clear"></div>
</form>

{% if issue_id > 0 %}
	<h3>Holdings of unnamed Investor Participants</h3>
	<p><a href="ipstakes.asp">Click here</a> to see all issues held by investor participants.</p>

	{% if history|length == 0 %}
		<p><b>No records found.</b></p>
	{% else %}
		{% if s != 2 %}
			{# Chart display #}
			<script type="text/javascript">
			document.addEventListener('DOMContentLoaded', function () {
				Highcharts.setOptions({
					lang: {
				      thousandsSep: ','
				    }
				});
				Highcharts.stockChart('chart1', {
			    	chart: {
			    		backgroundColor: "#FFFFFF",
				        borderWidth: 1,
				        borderColor: "black"
			    	},
			    	rangeSelector:{
			    		selected: 5,
			    		buttons: [{
								type: 'month',
								count: 1,
								text: '1m'
							}, {
								type: 'month',
								count: 3,
								text: '3m'
							}, {
								type: 'month',
								count: 6,
								text: '6m'
							}, {
								type: 'ytd',
								text: 'YTD'
							}, {
								type: 'year',
								count: 1,
								text: '1y'
							}, {
								type: 'year',
								count: 3,
								text: '3y'
							}, {
								type: 'year',
								count: 5,
								text: '5y'
							}, {
								type: 'year',
								count: 10,
								text: '10y'
							}, {
								type: 'all',
								text: 'All'
							}],
							inputDateFormat:"%e %b %Y"
			    	},
			        title: {
			            text: '<b>{{ stock_name|replace("'", "\\'") }}</b>',
			            margin: 10,
			            style: {
			            	fontSize:'1em'
				        }
			        },
			        subtitle: {
			        	text: 'Unnamed Investor Participants',
			        	style: {
			        		fontWeight: 'bold',
			        		fontSize: '1em'
			        	}
			        },
			        yAxis: [{
							title: {
					            text: 'Price'
					        },
					        height:'64%',
					        gridLineColor:'gray',
					        minorTickInterval:'auto',
					        lineWidth: 1,
					        min:null
					    }, {
					        title: {
					            text: 'Holding'
					        },
					        top:'65%',
					        height: '35%',
					        offset: 0,
					        lineWidth: 1,
					    }],
			        series: [{
			        	type: 'line',
			        	name: 'Price',
			        	id: 'adjClose',
			            data: {{ price_js|safe }},
			            dataGrouping: {
			            	enabled:false
						},
					    tooltip: {
					    	pointFormat: "<span style='color:{series.color}'>\u25CF</span> {series.name}: <b>{point.y:,.3f}</b><br>",
					    	shared:true
					    },
					}, {
					    type: 'column',
					    name: 'Holding',
					    data: {{ holdings_js|safe }},
				        color: "grey",
			            dataGrouping: {
			            	enabled:false
			            },
					    yAxis: 1
					}],
					tooltip:{
						backgroundColor: 'yellow',
						xDateFormat: "%a, %e %b, %Y",
						headerFormat: '<span style="font-size: 12px">{point.key}</span><br/>'
					},
					credits:{
						enabled: true,
						position: {
							align:'left',
							x:5,
							verticalAlign:'bottom',
							y:-5
						}
					}
				});
			});
			</script>
			<div id="chart1" style="width:95%;height:500px;margin-left:0"></div>
			<div class="clear"></div>
		{% endif %}

		{% if s != 1 %}
			{# Data table #}
			<h3>Data table</h3>
			{% if not a %}
				<p>Prices, holdings and issued shares are unadjusted for splits and bonus issues.</p>
			{% else %}
				<p>Prices, holdings and issued shares are adjusted for splits and bonus issues.</p>
			{% endif %}
			{% if p %}
				<p>Using prices on the holding/settlement date, not the trade date.</p>
			{% else %}
				<p>Using prices on the last related trading date, which is 2 trading days before settlement.</p>
			{% endif %}
			{{ mobile(1)|safe }}
			<table class="numtable yscroll">
			<tr>
				<th class="colHide1">Row</th>
				<th>Holding<br>date</th>
				<th>Holding</th>
				<th>Change</th>
				<th>Stake<br>%</th>
				<th class="colHide3">Hold<br>-ers</th>
				<th class="colHide1">Issued<br>shares</th>
				<th class="colHide3">Holding<br>Value</th>
				<th class="colHide3">Price @<br>{{ pword }}<br>date</th>
				<th class="colHide2">Trade<br>date</th>
			</tr>
			{% for row in history %}
				<tr>
					<td class="colHide1">{{ loop.index }}</td>
					<td><a href="chldchg.asp?i={{ issue_id }}&amp;d={{ row.atDate.strftime('%Y-%m-%d') }}">{{ row.atDate.strftime('%Y-%m-%d') }}</a></td>
					{% if last_hold_date is none or row.atDate <= last_hold_date %}
						<td>{{ "{:,.0f}".format(row.holding) }}</td>
						<td>
							{% if row.change is not none %}
								{{ "{:,.0f}".format(row.change) }}
							{% endif %}
						</td>
						{% if row.os is not none and row.os > 0 %}
							<td>{{ "{:,.2f}".format(row.holding / row.os * 100) }}</td>
							<td class="colHide3">{{ row.holders if row.holders is not none else '' }}</td>
							<td class="colHide1">{{ "{:,.0f}".format(row.os) }}</td>
						{% else %}
							<td></td>
							<td class="colHide3">{{ row.holders if row.holders is not none else '' }}</td>
							<td class="colHide1"></td>
						{% endif %}
						<td class="colHide3">
							{% if row.closing > 0 %}
								{{ "{:,.0f}".format(row.closing * row.holding) }}
							{% else %}
								-
							{% endif %}
						</td>
					{% else %}
						<td colspan="3"></td>
						<td class="colHide3"></td>
						<td class="colHide1"></td>
						<td class="colHide3"></td>
					{% endif %}
					<td class="colHide3">{{ sig(row.closing) }}</td>
					<td class="colHide2">{{ row.tradeDate.strftime('%Y-%m-%d') }}</td>
				</tr>
			{% endfor %}
			</table>
		{% endif %}
	{% endif %}
{% endif %}
{% endblock %}
