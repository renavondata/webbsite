<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History of CCASS shareholding</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/main.css') }}">
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
</head>
<body>
{% include 'includes/dbheader.html' %}

<h2>History of CCASS shareholding</h2>

{% if issue_id == 0 %}
    <p><b>{{ stock_name }}</b></p>
{% else %}
    {# TODO: Add navigation bars when database available #}
    <form method="get" action="{{ url_for('ccass.chistory') }}">
        <input type="hidden" name="part" value="{{ part_id }}">
        <input type="hidden" name="i" value="{{ issue_id }}">
        <div class="inputs">
            Stock code: <input type="text" name="sc" id="stockCode" size="5" value="">
        </div>
        <div class="clear"></div>
        <div class="inputs">
            <p>Adjust for splits and bonus issues:
                <input type="radio" name="a" value="1" {% if a==1 %}checked{% endif %} onchange="this.form.submit()">Yes
                <input type="radio" name="a" value="0" {% if a==0 %}checked{% endif %} onchange="this.form.submit()">No
            </p>
            <p>Use price on:
                <input type="radio" name="p" value="0" {% if p==0 %}checked{% endif %} onchange="this.form.submit()">trading date
                <input type="radio" name="p" value="1" {% if p==1 %}checked{% endif %} onchange="this.form.submit()">holding/settlement date
            </p>
            <p>Show:
                <input type="radio" name="s" value="0" {% if s==0 %}checked{% endif %} onchange="this.form.submit()">chart &amp; table
                <input type="radio" name="s" value="1" {% if s==1 %}checked{% endif %} onchange="this.form.submit()">chart only
                <input type="radio" name="s" value="2" {% if s==2 %}checked{% endif %} onchange="this.form.submit()">table only
            </p>
            <p>Table rows with no holding change:
                <input type="radio" name="o" value="1" {% if o==1 %}checked{% endif %} onchange="this.form.submit()">include
                <input type="radio" name="o" value="0" {% if o==0 %}checked{% endif %} onchange="this.form.submit()">exclude
            </p>
            <input type="submit" value="Go">
        </div>
        <div class="clear"></div>
    </form>

    <h3>Participant: {{ part_name }}</h3>

    {% if part_id == 0 %}
        <p><b>No participant specified</b></p>
    {% elif issue_id == 0 %}
        <p><b>No stock specified</b></p>
    {% elif holdings_data|length == 0 %}
        <p><b>No holdings data available for this participant in this stock.</b></p>
    {% else %}
        {# Chart container (shown if s == 0 or s == 1) #}
        {% if s != 2 %}
            <div id="chart1" style="height: 600px; margin: 20px 0; border: 1px solid black; background-color: #FFFFFF;"></div>
        {% endif %}

        {# Table (shown if s == 0 or s == 2) #}
        {% if s != 1 %}
            <h3>Holdings history</h3>
            <table class="numtable yscroll">
                <tr>
                    <th>Date</th>
                    <th>Trade date</th>
                    <th>Closing price</th>
                    <th>Holdings</th>
                    <th>Change</th>
                    <th>% of o/s</th>
                    <th>Value (HK$)</th>
                </tr>
                {% for row in table_data %}
                <tr>
                    <td><a href="{{ url_for('ccass.chldchg', i=issue_id, d=row.atDate) }}">{{ row.atDate.strftime('%Y-%m-%d') if row.atDate else '' }}</a></td>
                    <td>{{ row.tradeDate.strftime('%Y-%m-%d') if row.tradeDate else '' }}</td>
                    <td class="num">{{ "{:.3f}".format(row.closing) if row.closing else '' }}</td>
                    <td class="num">{{ "{:,.0f}".format(row.holding) if row.holding else '0' }}</td>
                    <td class="num">{{ "{:+,.0f}".format(row.change) if row.change is not none else '' }}</td>
                    <td class="num">{{ "{:.2f}%".format(row.pct_outstanding * 100) if row.pct_outstanding else '' }}</td>
                    <td class="num">{{ "{:,.0f}".format(row.value) if row.value else '' }}</td>
                </tr>
                {% endfor %}
            </table>
        {% endif %}

        {# Highstock chart JavaScript #}
        {% if s != 2 %}
        <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            Highcharts.setOptions({
                lang: {
                    thousandsSep: ','
                }
            });

            Highcharts.stockChart('chart1', {
                chart: {
                    backgroundColor: '#FFFFFF',
                    borderWidth: 1,
                    borderColor: 'black'
                },
                rangeSelector: {
                    selected: 5,
                    buttons: [{
                        type: 'month',
                        count: 1,
                        text: '1m'
                    }, {
                        type: 'month',
                        count: 3,
                        text: '3m'
                    }, {
                        type: 'month',
                        count: 6,
                        text: '6m'
                    }, {
                        type: 'ytd',
                        text: 'YTD'
                    }, {
                        type: 'year',
                        count: 1,
                        text: '1y'
                    }, {
                        type: 'year',
                        count: 3,
                        text: '3y'
                    }, {
                        type: 'year',
                        count: 5,
                        text: '5y'
                    }, {
                        type: 'year',
                        count: 10,
                        text: '10y'
                    }, {
                        type: 'all',
                        text: 'All'
                    }],
                    inputDateFormat: '%e %b %Y'
                },
                title: {
                    text: '<b>{{ stock_name|safe }}</b>',
                    margin: 10,
                    style: {
                        fontSize: '1em'
                    }
                },
                subtitle: {
                    text: 'Participant: {{ part_name|safe }}',
                    style: {
                        fontWeight: 'bold',
                        fontSize: '1em'
                    }
                },
                xAxis: {
                    type: 'datetime'
                },
                yAxis: [{
                    title: {
                        text: 'Price'
                    },
                    height: '64%',
                    gridLineColor: 'gray',
                    minorTickInterval: 'auto',
                    lineWidth: 1,
                    min: null,
                    opposite: false,
                    labels: {
                        format: '{value:.3f}'
                    }
                }, {
                    title: {
                        text: 'Holding'
                    },
                    top: '65%',
                    height: '35%',
                    offset: 0,
                    lineWidth: 1,
                    opposite: false,
                    labels: {
                        format: '{value:,.0f}'
                    }
                }],
                tooltip: {
                    backgroundColor: 'yellow',
                    xDateFormat: '%a, %e %b, %Y',
                    headerFormat: '<span style="font-size: 12px">{point.key}</span><br/>',
                    shared: true
                },
                series: [{
                    type: 'line',
                    name: 'Price',
                    id: 'adjClose',
                    data: {{ price_data|tojson }},
                    yAxis: 0,
                    dataGrouping: {
                        enabled: false
                    },
                    tooltip: {
                        pointFormat: "<span style='color:{series.color}'>\u25CF</span> {series.name}: <b>{point.y:,.3f}</b><br>"
                    }
                }, {
                    type: 'column',
                    name: 'Holding',
                    data: {{ holdings_data|tojson }},
                    color: 'grey',
                    yAxis: 1,
                    dataGrouping: {
                        enabled: false
                    },
                    tooltip: {
                        pointFormat: "<span style='color:{series.color}'>\u25CF</span> {series.name}: <b>{point.y:,.0f}</b><br>"
                    }
                }],
                credits: {
                    enabled: true,
                    position: {
                        align: 'left',
                        x: 5,
                        verticalAlign: 'bottom',
                        y: -5
                    }
                }
            });
        });
        </script>
        {% endif %}
    {% endif %}
{% endif %}

{% include 'includes/footer.html' %}
</body>
</html>
