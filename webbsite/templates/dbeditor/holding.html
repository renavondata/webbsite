{%extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<!--#include file="cotop.inc"-->
{% if i>0 %}
	<h2>{{ iName }}</h2>
	{# TODO: Port ASP logic: Call orgBar(issuerID,8)
	Call issueBar(i,4)
ElseIf... #}
	<h2>{{ name }}</h2>
	{# TODO: Port ASP logic: Call orgBar(issuerID,8)
End If... #}
<h2>{{ title }}</h2>
<h3>Issue</h3>
<form action="holding.asp" method="post" name="myform">
	{% if issuerID=0 %}
		<p>Listed:
		{{ arrSelectZ("i","",conRole.Execute("SELECT DISTINCT issueID,CONCAT(name,':',typeShort) FROM issuesforhku").GetRows,True,True,0,"Select") }}
		</p>
		<p>Unlisted: <a href="searchorgs.asp?tv=issuer">Find or add an issuer</a></p>
		{% if Not listed and lastListed!="" %}
			<p><a href="holding.asp?i={{ lastListed }}&amp;targDate={{ targDate }}">Use last listed issue</a></p>
		{% endif %}	
	{% else %}
		<input type="hidden" name="ti" value="{{ issuerID }}">
		<table class="txtable">
			<tr>
				<td>Issuer:</td>
				<td><a target="_blank" href="/dbpub/orgdata.asp?p={{ issuerID }}">{{ name }}</a></td>
				<td><a href="holding.asp?targDate={{ targDate }}">Clear</a></td>
			</tr>
			<tr>
				<td>Issuer ID:</td>
				<td>{{ issuerID }}</td>
				<td></td>
			</tr>
			{% if i>0 %}
				<tr>
					<td>Issue:</td>
					<td>
						{{ typeShort }}:{{ typeLong }}
						<input type="hidden" name="i" value="{{ i }}">
					</td>
					<td><a href="holding.asp?targDate={{ targDate }}&amp;issuer={{ issuerID }}">Clear</a></td>
				</tr>
				<tr>
					<td>Issue ID:</td>
					<td>{{ i }}</td>
					<td></td>
				</tr>
				<tr>
					<td>Listed:</td>
					<td>{{ listed }}</td>
					<td>
						{% if Not listed and lastListed!="" %}
							<a href="holding.asp?i={{ lastListed }}&amp;targDate={{ targDate }}">Use last listed issue</a>
						{% endif %}
					</td>
				</tr>
			{% else %}
				<tr>
					<td>Issue:</td>					
					<td>
						{# sql="SELECT ID1,CONCAT(typeShort,':',typeLong) FROM issue i JOIN secTypes s ON i.typeID=s.typeID WHERE i.typeID NOT IN(1,2,41) AND issuer="&issuerID
						rs.Open sql,conRole
						If Not rs.EOF Then Response.Write arrSelect("i",i,rs.GetRows,True)
						rs.Close #}
					</td>
					<td><a href="issue.asp?tv=i&amp;p={{ issuerID }}">Add or delete an issue for this organisation.</a></td>
				</tr>			
			{% endif %}
		</table>
	{% endif %}
	<p>Snapshot date: 
		<input type="date" name="targDate" value="{{ targDate }}" onblur="this.form.submit()">	
		<%If issuerID>0 Then
			sql="SELECT DISTINCT DATE_FORMAT(atDate,'%Y-%m-%d'),DATE_FORMAT(atDate,'%Y-%m-%d') FROM sholdings s JOIN issue i ON s.issueID=i.ID1 WHERE Not isNull(atDate) AND i.issuer="&issuerID&" ORDER BY atDate"
			rs.Open sql,conRole
			If Not rs.EOF Then Response.Write arrSelectZ("kd","",rs.GetRows,True,True,"","Known dates")
			rs.Close
		End If%>
		<input type="submit" value="Go">
	</p>
	{% if listed and targDate!="" %}
		<p><a target="_blank" href="snaplog.asp?j=0&p={{ issuerID }}&d={{ targDate }}">Log this snapshot</a></p>
	{% endif %}
	{% if Not isNull(outstanding) %}
		<h4>Outstanding shares</h4>
		<table class="numtable fcl">
		<tr>
			<th>Date</th>
			<th>Outstanding shares</th>
			<th>Entered on</th>
			<th>User</th>
			<th></th>
		</tr>
		<tr>
			<td>{{ targDate }}</td>
			<td>{{ "{:,.\2f}".format(outstanding) }}</td>
			<td>{{ issuedMod }}</td>
			<td>{{ issuedUser }}</td>
			<td><a href="issued.asp?i={{ i }}&d={{ targDate }}" target="_blank">Edit</a></td>
		</tr>
		</table>
	{% else %}
		<p><a href="issued.asp?i={{ i }}&d={{ targDate }}" target="_blank">Enter issued shares</a></p>
	{% endif %}
</form>
{# TODO: Port ASP logic: If i>0 And targDate<>"" Then
	If targHolder<>"" An... #}
			<h4>Existing record</h4>
			<table class="numtable">
			<tr>
				<th class="left">Holder</th>
				<th class="left">Date</th>
				<th class="left">Held as</th>
				<th style="width:120px">Shares held</th>
				<th style="width:70px">Stake</th>
				<th>User</th>
				<th>Timestamp</th>
			</tr>
			<tr>
				<td>{{ holderName }}</td>
				<td>{{ targDate }}</td>
				<td>{{ heldAsTxt }}</td>
				<td>{{ intStr(recShares) }}</td>
				<td>
				{# TODO: Port ASP logic: If Not isNull(outstanding) And Not isNull(recShare... #}
				</td>
				<td>{{ recUser }}</td>
				<td>{{ recModified }}</td>
			</tr>
			</table>
			{% if canEdit %}
				<form action="holding.asp" method="post">
					<input type="hidden" name="r" value="{{ recID }}">
					<input type="hidden" name="i" value="{{ i }}">
					<input type="hidden" name="targDate" value="{{ targDate }}">
					<input type="hidden" name="h{{ holdType }}" value="{{ targHolder }}">
					<input type="hidden" name="ht" value="{{ holdType }}">
					<input type="hidden" name="ha" value="{{ heldAs }}">
					<input type="hidden" name="targShares" value="{{ targShares }}">
					<input type="hidden" name="targStake" value="{{ targStake }}">
					<p><input type="submit" name="submitBtn" value="Delete"></p>
				</form>
			{# TODO: Port ASP logic: End If
		End If
		If canEdit And Not Done Then
			... #}
			<form action="holding.asp" method="post">
				<input type="hidden" name="targDate" value="{{ targDate }}">
				<input type="hidden" name="h{{ holdType }}" value="{{ targHolder }}">
				<input type="hidden" name="i" value="{{ i }}">
				<input type="hidden" name="ht" value="{{ holdType }}">
				<input type="hidden" name="ha" value="{{ heldAs }}">
				<h4>Proposed record</h4>
				<table class="numtable">
					<tr>
						<th class="left">Holder</th>
						<th class="left">Date</th>
						<th class="left">Held as</th>
						<th style="width:120px">Shares held</th>
						<th style="width:70px">Stake</th>
					</tr>
					<tr>
						<td><a target="_blank" href="/dbpub/{{ pURL }}">{{ holderName }}</a></td>
						<td>{{ targDate }}</td>
						<td class="left">{{ heldAsTxt }}</td>
						{# TODO: Port ASP logic: If targShares=0 Then strTargShares=""
						If tar... #}
						<td><input type="text" name="targShares" style="text-align:right;width:114px" value="{{ strTargShares }}"></td>
						<td>
							{% if Not listed %}<input type="text" name="targStake" style="text-align:right;width:64px" value="{{ strTargStake }}">{% endif %}
						</td>
					</tr>
				</table>
				<p>
					<input type="submit" name="submitBtn" value="Confirm">&nbsp;
					<input type="submit" name="submitBtn" value="Cancel">
				</p>
			</form>
		{# TODO: Port ASP logic: End If
	Else
		'select holder and heldAs... #}
		<form action="holding.asp" method="post">
			<input type="hidden" name="i" value="{{ i }}">
			<input type="hidden" name="targDate" value="{{ targDate }}">
			<h3>Holder</h3>
			{# 'list of directors
			sql="SELECT distinct director as holderID,fnameppl(name1,name2,cname) as name FROM directorships JOIN people "&_
				"ON director=personID WHERE company="&issuerID&" AND (isNull(apptDate) or apptDate<='"&targDate&_
				"') AND (isNull(resDate) OR resDate>'"&targDate&"') ORDER BY name"
			rs.Open sql,conRole #}
			<p>
				<input type="radio" id="rb1" name="ht" value="1"{{ checked(holdType=1) }}>
				Director/senior manager: 
				{# TODO: Port ASP logic: If rs.EOF Then
					Response.Write "None found."
	... #}
					{{ arrSelectOnchZ("h1",targHolder,rs.GetRows,"document.getElementById('rb1').checked=true;",True,"","") }}
				{# TODO: Port ASP logic: End If
				rs.Close... #}
			</p>
			{# 'list of known shareholders
			rs.Open "SELECT DISTINCT holderID, namepsn(o.name1,p.name1,name2) AS name,CAST(p.cName AS CHAR) AS cName "&_
				"FROM sholdings LEFT JOIN organisations o ON holderID=o.personID "&_
				"LEFT JOIN people p on holderID=p.personID "&_
				"WHERE issueID="&i&" ORDER BY name",conRole #}
			<p>
				<input type="radio" id="rb2" name="ht" value="2"{{ checked(holdType=2) }}>
				Known shareholders: 
				{# TODO: Port ASP logic: IF rs.EOF Then
					Response.Write "None found."
	... #}
					{{ arrSelectOnchZ("h2",targHolder,rs.GetRows,"document.getElementById('rb2').checked=true;",True,"","") }}
				{# TODO: Port ASP logic: End If
				rs.Close... #}
			</p>
			<p>
				<input type="radio" id="rb3" name="ht" value="3"{{ checked(holdType=3) }}>
				{# TODO: Port ASP logic: If holdType=3 And targHolder<>"" Then
					'we've ... #}
					<a target="_blank" href="/dbpub/orgdata.asp?p={{ targHolder }}">{{ holderName }}</a>
					<input type="hidden" name="h3" value="{{ targHolder }}">
					</p><p><a href="searchorgs.asp?tv=org">Find another organisation</a>
				{% else %}
					<a href="searchorgs.asp?tv=org">Find or add an organisation</a>
				{% endif %}
			</p>
			<p>
				<input type="radio" id="rb4" name="ht" value="4"{{ checked(holdType=4) }}>
				{# TODO: Port ASP logic: If holdType=4 And targHolder<>"" Then
					'we've ... #}
					<a target="_blank" href="/dbpub/natperson.asp?p={{ targHolder }}">{{ holderName }}</a>
					<input type="hidden" name="h4" value="{{ targHolder }}">
					</p><p><a href="searchpeople.asp?tv=ppl">Find another human</a>
				{% else %}
					<a href="searchpeople.asp?tv=ppl">Find or add a human</a>
				{% endif %}		
			</p>
			<h3>Holding Type</h3>
			<p>{{ arrSelect("ha",heldAs,conRole.Execute("SELECT ID,heldAsTxt FROM heldAs ORDER BY heldAsTxt").GetRows,True) }}</p>
			<p><input type="submit" name="submitBtn" value="Next step"></p>
		</form>
	{# TODO: Port ASP logic: End If
End If
If hint<>"" Then... #}
	<p><b>{{ hint }}</b></p>
{% endif %}
{% if targDate!="" and i>0 %}
	<hr>
	<h3>Latest direct holders on or before {{ targDate }}</h3>
	{# Set rs=conRole.Execute("Call holdersdate("&i&",'"&targDate&"')")
	If rs.EOF Then #}
		<p>None found.</p>
	{% else %}
		<form method="post" action="holding.asp">
			<input type="hidden" name="targDate" value="{{ targDate }}">
			<input type="hidden" name="i" value="{{ i }}">
			<table class="numtable">
			<tr>
				<th class="left">Holder (click for history)</th>
				<th class="left">Date</th>
				<th>Update</th>
				<th>Edit</th>
				<th>Delete</th>
				<th class="left">Held as</th>
				<th>Shares held</th>
				<th>Stake</th>
				<th>User</th>
				<th>Timestamp</th>
				<th></th>
			</tr>
			{# Do Until rs.EOF
				stake=Null
				recID=rs("recID")
				atDate=rs("atDate")
				shares=rs("shares")
				holderName=rs("holderName")&" "&rs("cName")
				If rs("hklistco") Then holderName="<b>"&holderName&"</b>"
				If isNull(shares) Then
					stake=rs("stake")
					If Not isNull(stake) Then sumStake=stake+sumStake
				Else
					sumShares=sumShares+shares
					If outstanding<>0 Then
						stake=shares/outstanding
						sumStake=stake+sumStake
					End If
				End If #}
				<tr>
					<td class="left"><a target="_blank" href='holdinghist.asp?p={{ issuerID }}&amp;h={{ row.holderID }}'>{{ holderName }}</a></td>
					<td>{{ atDate }}</td>
					<td style="text-align:center">
						{% if isNull(atDate) or atDate<cDate(targDate) %}
							<input type="checkbox" name="updRec" value="{{ recID }}">
						{% endif %}
					</td>
					<td><a href="holding.asp?r={{ recID }}&amp;targDate={{ targDate }}">Edit</a></td>
					<td class="center">
						{% if rankingRs(rs,uRank) %}
							<input type="checkbox" name="delRec" value="{{ recID }}">
						{% endif %}
					</td>
					<td>{{ row.heldAsTxt }}</td>
					<td>{# TODO: Port ASP logic: If Not isNull(shares) Then Response.Write FormatNu... #}</td>
					<td>{# TODO: Port ASP logic: If Not isNull(stake) Then Response.Write FormatPer... #}</td>
					<td>{{ row.user }}</td>
					<td>{{ MSdateTime(row.modified) }}</td>
					<td>
					{% if row.ht="O" %}
					<a href='holding.asp?issuer={{ row.holderID }}&amp;d={{ targDate }}'>Ownership</a>
					{% endif %}
					</td>
				</tr>
				{# TODO: Port ASP logic: rs.MoveNext
			Loop... #}
			<tr>
				<td class="left" colspan="6">Total</td>
				<td>{# TODO: Port ASP logic: If sumShares<>"" Then Response.Write FormatNumber(... #}</td>
				<td>{# TODO: Port ASP logic: If sumStake<>"" Then Response.Write FormatPercent(... #}</td>
			</tr>
			</table>
			<br>
			<input type="submit" name="submitBtn" style="color:red" value="Update records">
			<input type="submit" name="submitBtn" style="color:blue" value="Update and zero">
			<input type="submit" name="submitBtn" style="color:red" value="Delete records">
		</form>
	{# TODO: Port ASP logic: End If
	rs.Close... #}
	<hr>
	<h3>Ownership tree on or before {{ targDate }}</h3>
	<!--#include file="holders.inc"-->
	<hr>
	<h3>Holdings tree on or before {{ targDate }}</h3>
	<!--#include file="holdings.inc"-->
	<hr>
{# TODO: Port ASP logic: End  If
If i>0 Then... #}
	<p><a target="_blank" href="snaplog.asp?p={{ issuerID }}">Snapshot logs for this issuer</a></p>
	<p><a target="_blank" href="/dbpub/docs.asp?p={{ issuerID }}">View financial reports for this issuer</a></p>
{# TODO: Port ASP logic: End If
Call closeConRs(conRole,rs)... #}
<!--#include file="cofooter.asp"-->
{% endblock %}
