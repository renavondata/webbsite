{% extends "base_database.html" %}
{% block extra_head %}
<script type="text/javascript" src="/static/js/highstock.js"></script>
<script type="text/javascript" src="/static/js/exporting.js"></script>
{% endblock %}
{% block title %}Webb-site Total Return: {{ stock_name if stock_name else 'Unknown' }}{% endblock %}
{% block content %}
{% if i == 0 %}
<h2>{{ stock_name if stock_name else 'Stock not found.' }} </h2>
{% else %}
{# Organization title and navigation #}
<h2>{{ stock_name }}</h2>

{# Organization Navigation Bar - matching orgBar from navbars.asp #}
<ul class="navlist">
    <li><a href="/dbpub/orgdata.asp?p={{ person_id }}">Key Data</a></li>
    {% if org_nav.has_officers %}
        <li><a href="/dbpub/officers.asp?p={{ person_id }}">Officers</a></li>
        <li><a href="/dbpub/overlap.asp?p={{ person_id }}">Overlaps</a></li>
    {% endif %}
    {% if org_nav.has_pay %}
        <li><a href="/dbpub/pay.asp?p={{ person_id }}">Pay</a></li>
    {% endif %}
    {% if org_nav.has_advisers %}
        <li><a href="/dbpub/advisers.asp?p={{ person_id }}">Advisers</a></li>
    {% endif %}
    {% if org_nav.has_adviserships %}
        <li><a href="/dbpub/adviserships.asp?p={{ person_id }}">Adviserships</a></li>
    {% endif %}
    {% if org_nav.has_sfc_licenses %}
        <li><a href="/dbpub/SFColicrec.asp?p={{ person_id }}">SFC licenses</a></li>
    {% endif %}
    {% if org_nav.ccass_part_id %}
        <li><a href="/ccass/cholder.asp?part={{ org_nav.ccass_part_id }}">CCASS holdings</a></li>
    {% endif %}
    {% if org_nav.has_financials %}
        <li><a href="/dbpub/docs.asp?p={{ person_id }}">Financials</a></li>
    {% endif %}
    {% if org_nav.has_ess %}
        <li><a href="/dbpub/ESSraw.asp?p={{ person_id }}">ESS</a></li>
    {% endif %}
    {% if org_nav.has_articles %}
        <li><a href="/dbpub/articles.asp?p={{ person_id }}">Webb-site Reports</a></li>
    {% endif %}
    {% if org_nav.has_complain %}
        <li><a href="/dbpub/complain.asp?p={{ person_id }}">Complain</a></li>
    {% endif %}
</ul>
<div class="clear"></div>

{# Stock Listings Table - matching HKlistings from navbars.asp #}
{% if stock_listings %}
<table class="numtable" style="margin-top:5px">
    <tr>
        <th class="left">Exchange</th>
        <th>Code</th>
        <th>Listed</th>
        <th>Last trade</th>
        <th>Delisted</th>
        <th></th>
    </tr>
    {% for listing in stock_listings %}
    <tr>
        <td class="left" style="width:75px;vertical-align:middle">{{ listing.exchange_name }}</td>
        <td style="text-align:left;vertical-align:middle">{{ listing.stockcode_formatted }}</td>
        <td style="vertical-align:middle">&nbsp;{{ listing.firsttradedate.strftime('%Y-%m-%d') if listing.firsttradedate else '' }}</td>
        <td style="vertical-align:middle">&nbsp;{{ listing.finaltradedate.strftime('%Y-%m-%d') if listing.finaltradedate else '' }}</td>
        <td style="vertical-align:middle">&nbsp;{{ listing.delistdate.strftime('%Y-%m-%d') if listing.delistdate else '' }}</td>
        <td>
            {% if listing.stockid %}
                {% if not listing.delistdate or listing.delistdate > today %}
                    {% set docs_url = 'https://www1.hkexnews.hk/search/titlesearch.xhtml?lang=EN&market=SEHK&stockId=' + listing.stockid|string + '&category=0' %}
                {% else %}
                    {% set docs_url = 'https://www1.hkexnews.hk/search/titlesearch.xhtml?lang=EN&market=SEHK&stockId=' + listing.stockid|string + '&category=1' %}
                {% endif %}
                <ul class="navlist"><li><a target="_blank" href="{{ docs_url }}">Docs</a></li></ul>
            {% endif %}
        </td>
    </tr>
    {% endfor %}
</table>
<div class="clear"></div>
{% endif %}

{# Stock Navigation Bar - matching stockBar from navbars.asp #}
<ul class="navlist">
    {% if nav_flags.has_buybacks %}
        <li><a href="/dbpub/buybacks.asp?i={{ i }}">Buybacks</a></li>
    {% endif %}
    {% if nav_flags.has_outstanding %}
        <li><a href="/dbpub/outstanding.asp?i={{ i }}">Outstanding</a></li>
    {% endif %}
    {% if nav_flags.has_short %}
        <li><a href="/dbpub/short.asp?i={{ i }}">Short</a></li>
    {% endif %}
    {% if nav_flags.ccass_on %}
        <li><a href="/ccass/choldings.asp?i={{ i }}">CCASS</a></li>
    {% endif %}
    {% if nav_flags.has_hk_listed %}
        <li class="livebutton">Total return</li>
        <li><a href="/dbpub/ctr.asp?i1={{ i }}">Compare returns</a></li>
        <li><a href="/dbpub/hpu.asp?i={{ i }}">Prices</a></li>
        <li><a href="/dbpub/events.asp?i={{ i }}">Events</a></li>
    {% endif %}
    {% if nav_flags.has_sdi %}
        <li><a href="/dbpub/sdiissue.asp?i={{ i }}">Dealings</a></li>
    {% endif %}
    {# Quote button - external HKEX links based on security type #}
    {% if nav_flags.has_hk_listed and (not nav_flags.delist_date or nav_flags.delist_date > today) %}
        {% if nav_flags.sec_type not in [46, 40, 41] and nav_flags.stock_ex_id not in [23, 38] %}
            {# Regular equities #}
            {% if stock_listings and stock_listings[-1].stockcode %}
                <li><a target="_blank" href="http://www.hkex.com.hk/Market-Data/Securities-Prices/Equities/Equities-Quote?sym={{ stock_listings[-1].stockcode }}">Quote</a></li>
            {% endif %}
        {% elif nav_flags.stock_ex_id == 38 %}
            {# Exchange-Traded Products #}
            {% if stock_listings and stock_listings[-1].stockcode %}
                <li><a target="_blank" href="https://www.hkex.com.hk/Market-Data/Securities-Prices/Exchange-Traded-Products/Exchange-Traded-Products-Quote?sym={{ stock_listings[-1].stockcode }}">Quote</a></li>
            {% endif %}
        {% elif nav_flags.stock_ex_id == 23 %}
            {# REITs #}
            {% if stock_listings and stock_listings[-1].stockcode %}
                <li><a target="_blank" href="https://www.hkex.com.hk/Market-Data/Securities-Prices/Real-Estate-Investment-Trusts/Real-Estate-Investment-Trusts-Quote?sym={{ stock_listings[-1].stockcode }}">Quote</a></li>
            {% endif %}
        {% else %}
            {# Debt securities #}
            {% if stock_listings and stock_listings[-1].stockcode %}
                <li><a target="_blank" href="http://www.hkex.com.hk/Market-Data/Securities-Prices/Debt-Securities/Debt-Securities-Quote?sym={{ stock_listings[-1].stockcode }}">Quote</a></li>
            {% endif %}
        {% endif %}
    {% endif %}
</ul>
<div class="clear"></div>

<ul class="navlist">
    <li><a href="/dbpub/TRnotes.asp" target="_blank">Notes</a></li>
    <li><a href="/dbpub/alltotrets.asp">All Total Returns</a></li>
</ul>
<div class="clear"></div>
{% endif %}

<form method="get" action="/dbpub/str.asp">
    <div class="inputs">
        Stock code: <input type="text" name="sc" size="5" value="{{ sc if sc else '' }}">
    </div>
    <div class="inputs">
        <input type="hidden" name="i" value="{{ i }}">
        <input type="checkbox" id="dealCheck" name="f" value="1" {% if show_deals %}checked{% endif %}>show directors' on-market dealings
    </div>
    <div class="inputs">
        <input type="checkbox" id="bbCheck" name="b" value="1" {% if show_bb %}checked{% endif %}>show buybacks
    </div>
    <div class="inputs">
        <input type="submit" value="Go">
    </div>
    <div class="clear"></div>
</form>

<p>Please <a href="/contact">report</a> any errors or desired features.
For more help, see the <a href="/dbpub/TRnotes.asp" target="_blank">the notes</a>.</p>

{% if i > 0 and quotes %}
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function () {
    var flags = [],
        bbFlags = [],
        atDate;

    {% for flag in sdi_flags %}
    atDate = Date.parse("{{ flag.reldate }}");
    flags.push({
        x: atDate,
        title: '{{ flag.action[0] }}',
        text: '<a href="/dbpub/sdidirco.asp?p={{ flag.person_id }}&i={{ i }}">{{ flag.person_name|replace("'", "\\'") }}</a><br/>' +
            '<a href="/dbpub/sdicap.asp?r={{ flag.sdi_id }}">{{ flag.action }}' +
            ' {{ '{:,.0f}'.format(flag.shsinv) if flag.shsinv else '0' }} @{{ flag.currency }}{{ '%.3f'|format(flag.price) if flag.price else '' }}</a>'
    });
    {% endfor %}

    {% for bb in bb_flags %}
    atDate = Date.parse("{{ bb.effdate }}");
    bbFlags.push({
        x: atDate,
        title: 'R',
        text: 'Repurchase<br/>{{ '{:,.0f}'.format(bb.shares) }} @${{ '%.3f'|format(bb.value / bb.shares) if bb.shares and bb.value else '0' }}'
    });
    {% endfor %}

    Highcharts.setOptions({
        global: {useUTC: false},
        lang: {thousandsSep: ','}
    });

    const mychart = Highcharts.stockChart('graphdiv', {
        chart: {
            backgroundColor: "#FFFFFF",
            borderWidth: 1,
            borderColor: "black",
            height: (9/16*100)+'%'
        },
        rangeSelector: {
            selected: 6,
            buttons: [{
                type: 'month',
                count: 1,
                text: '1m'
            }, {
                type: 'month',
                count: 3,
                text: '3m'
            }, {
                type: 'month',
                count: 6,
                text: '6m'
            }, {
                type: 'ytd',
                text: 'YTD'
            }, {
                type: 'year',
                count: 1,
                text: '1y'
            }, {
                type: 'year',
                count: 3,
                text: '3y'
            }, {
                type: 'year',
                count: 5,
                text: '5y'
            }, {
                type: 'year',
                count: 10,
                text: '10y'
            }, {
                type: 'all',
                text: 'All'
            }],
            inputDateFormat: "%e %b %Y"
        },
        title: {
            text: '<b>{{ stock_name|replace("'", "\\'") }}</b>',
            margin: 10,
            style: {
                fontSize: '1em'
            }
        },
        subtitle: {
            text: 'Webb-site Total Return',
            style: {
                fontWeight: 'bold',
                fontSize: '1em'
            }
        },
        yAxis: [{
            title: {
                text: 'Adjusted close'
            },
            height: '70%',
            gridLineColor: 'gray',
            minorTickInterval: 'auto',
            lineWidth: 1,
            min: null
        }, {
            title: {
                text: 'Adjusted volume'
            },
            top: '70%',
            height: '30%',
            offset: 0,
            lineWidth: 1
        }],
        series: [{
            type: 'line',
            name: 'Adjusted close',
            id: 'adjClose',
            data: [
                {% for quote in quotes %}
                [{{ quote.timestamp|int }}, {{ '%.3f'|format(quote.adj_close) }}]{{ ',' if not loop.last else '' }}
                {% endfor %}
            ],
            dataGrouping: {
                enabled: false
            },
            tooltip: {
                shared: true,
                valueDecimals: 3
            }
        }, {
            type: 'column',
            name: 'Adjusted volume',
            data: [
                {% for quote in quotes %}
                [{{ quote.timestamp|int }}, {{ '{:,.0f}'.format(quote.adj_vol)|replace(',', '') }}]{{ ',' if not loop.last else '' }}
                {% endfor %}
            ],
            color: 'grey',
            dataGrouping: {
                enabled: false
            },
            yAxis: 1
        }, {
            type: 'flags',
            data: flags,
            id: 'dealingFlags',
            onSeries: 'adjClose',
            shape: 'squarepin',
            stickyTracking: true,
            fillColor: "yellow",
            stackDistance: 30,
            turboThreshold: 0,
            visible: {{ 'true' if show_deals else 'false' }}
        }, {
            type: 'flags',
            data: bbFlags,
            id: 'bbFlags',
            onSeries: 'adjClose',
            shape: 'squarepin',
            stickyTracking: true,
            lineColor: 'red',
            fillColor: "Turquoise",
            style: {color: 'black'},
            stackDistance: 30,
            turboThreshold: 0,
            visible: {{ 'true' if show_bb else 'false' }}
        }],
        tooltip: {
            backgroundColor: 'yellow',
            xDateFormat: "%a, %e %b, %Y",
            headerFormat: '<span style="font-size: 12px">{point.key}</span><br/>'
        },
        credits: {
            enabled: true,
            position: {
                align: 'left',
                x: 5,
                verticalAlign: 'bottom',
                y: -5
            }
        }
    });

    document.getElementById('dealCheck').addEventListener('click', () => {
        mychart.series[2].setVisible(!mychart.series[2].visible);
    });
    document.getElementById('bbCheck').addEventListener('click', () => {
        mychart.series[3].setVisible(!mychart.series[3].visible);
    });
});
</script>
<div id="graphdiv" style="width:95vw;"></div>
<div class="clear"></div>
{% endif %}
{% endblock %}
