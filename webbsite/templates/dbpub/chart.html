{% extends "base_database.html" %}
{% block title %}{{ title }}{% endblock %}

{% block extra_head %}
<script src="https://code.highcharts.com/stock/highstock.js"></script>
<script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
<script src="https://code.highcharts.com/stock/modules/export-data.js"></script>
{% endblock %}

{% block content %}
<h2>Economic Data Charts</h2>

{% if error %}
<p><b>{{ error }}</b></p>
{% else %}

<form method="get" action="{{ url_for('dbpub_market_data.chart') }}">
	<div class="inputs">
		Chart:
		<select name="c" onchange="this.form.submit()">
			{% for ch in all_charts %}
			<option value="{{ ch.id }}" {% if ch.id == c %}selected{% endif %}>{{ ch.title }}</option>
			{% endfor %}
		</select>
		{% if quant and freq < 3 %}
			<input type="checkbox" name="d" id="d" value="1" {% if daily %}checked{% endif %} onchange="this.form.submit()">
			<label for="d">Show per day</label>
		{% endif %}
	</div>
</form>

<h3>{{ title }}</h3>
{% if note %}
<p><em>{{ note }}</em></p>
{% endif %}

{% if table_data %}
<!-- Interactive Chart -->
<div id="chartContainer" style="height: 500px; min-width: 310px; margin-bottom: 20px;"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
	// Prepare series data
	var seriesData = [
		{% for i, item in enumerate(items) %}
		{
			name: '{{ item.shortname or item.ddes }}',
			data: {{ series_data[i] | tojson }},
			tooltip: {
				valueDecimals: {{ item.dp + dpinc if item.dp else 2 }}
			}
		}{% if not loop.last %},{% endif %}
		{% endfor %}
	];

	// Create the chart
	Highcharts.stockChart('chartContainer', {
		rangeSelector: {
			selected: 5,
			buttons: [{
				type: 'year',
				count: 1,
				text: '1y'
			}, {
				type: 'year',
				count: 2,
				text: '2y'
			}, {
				type: 'year',
				count: 5,
				text: '5y'
			}, {
				type: 'year',
				count: 10,
				text: '10y'
			}, {
				type: 'all',
				text: 'All'
			}]
		},

		title: {
			text: '{{ title }}'
		},

		yAxis: {
			title: {
				text: '{{ units }}'
			}
		},

		tooltip: {
			pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b><br/>',
			split: true
		},

		legend: {
			enabled: true
		},

		series: seriesData,

		exporting: {
			enabled: true,
			buttons: {
				contextButton: {
					menuItems: ['viewFullscreen', 'printChart', 'separator', 'downloadPNG', 'downloadJPEG', 'downloadPDF', 'downloadSVG', 'separator', 'downloadCSV', 'downloadXLS']
				}
			}
		},

		credits: {
			enabled: false
		}
	});
});
</script>

<!-- Data Table -->
<h4>Data Table</h4>
<p class="widthAlert1">Some columns may be hidden on narrow displays.</p>
<table class="numtable yscroll">
	<tr>
		<th class="colHide1">Row</th>
		<th>Date</th>
		{% for item in items %}
		<th>{{ item.shortname or item.ddes }}</th>
		{% endfor %}
	</tr>
	{% for row in table_data %}
	<tr>
		<td class="colHide1">{{ loop.index }}</td>
		<td>{{ row.date.strftime(tipdate) if row.date else '' }}</td>
		{% for value in row['values'] %}
		<td>
			{% if value is not none %}
				{% set item = items[loop.index0] %}
				{% if item.dp %}
					{{ ('{:,.%df}' % (item.dp + dpinc)).format(value) }}
				{% else %}
					{{ '{:,.2f}'.format(value) }}
				{% endif %}
			{% else %}
				-
			{% endif %}
		</td>
		{% endfor %}
	</tr>
	{% endfor %}
</table>

{% if sources %}
<p class="footnote">
	<b>Source{{ 's' if sources|length > 1 else '' }}:</b>
	{% for source in sources %}
		<a href="{{ url_for('dbpub_statistics.orgdata', p=source.source) }}">{{ source.name1 }}</a>{% if not loop.last %}, {% endif %}
	{% endfor %}
</p>
{% endif %}

{% else %}
<p><b>No data available for this chart.</b></p>
{% endif %}

{% endif %}
{% endblock %}
