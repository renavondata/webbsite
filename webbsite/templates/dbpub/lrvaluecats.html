{% extends "base_database.html" %}
{% block title %}{{ title }}{% endblock %}
{% block content %}
<h2>{{ title }}</h2>

<form method="get">
    <label><input type="checkbox" name="g" value="1" {% if selected_g %}checked{% endif %} onchange="this.form.submit()"> Group by $5m bands</label>
    <label><input type="checkbox" name="p" value="1" {% if selected_p %}checked{% endif %} onchange="this.form.submit()"> Show as percentage</label>
    <select name="f" onchange="this.form.submit()">
        <option value="0" {% if selected_f == 0 %}selected{% endif %}>Monthly</option>
        <option value="1" {% if selected_f == 1 %}selected{% endif %}>Annual</option>
    </select>
</form>

{% if data and data[0].data %}
<p>Data by value category. Latest data: {{ max_date }}</p>
<table class="numtable">
    <tr>
        <th class="left">Period</th>
        {% for cat_name in categories %}
        <th>{{ cat_name }}</th>
        {% endfor %}
        <th>Total</th>
    </tr>
    {# Build a dict of period -> category values #}
    {% set ns = namespace(periods=[]) %}
    {% for row in data[0].data %}
        {% set _ = ns.periods.append(row.period) %}
    {% endfor %}
    {% for period in ns.periods %}
    <tr>
        <td>{{ period }}</td>
        {% set ns2 = namespace(row_total=0) %}
        {% for cat_data in data %}
            {% set val = 0 %}
            {% for row in cat_data.data %}
                {% if row.period == period %}
                    {% set val = row.units|default(0)|int %}
                {% endif %}
            {% endfor %}
            {% if selected_p and ns2.row_total != -1 %}
                <td class="r">{{ val }}</td>
            {% else %}
                <td class="r">{{ "{:,}".format(val) if val else '' }}</td>
            {% endif %}
            {% set ns2.row_total = ns2.row_total + val %}
        {% endfor %}
        <td class="r"><b>{{ "{:,}".format(ns2.row_total) }}</b></td>
    </tr>
    {% endfor %}
</table>
<p>{{ ns.periods|length }} periods, {{ categories|length }} categories</p>
{% else %}
<p>No data available.</p>
{% endif %}
{% endblock %}
